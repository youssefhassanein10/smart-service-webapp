<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Smart Service - MiniApp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<header class="bg-primary text-white py-3 mb-4 text-center">
  <h1 id="storeName">Smart Service</h1>
  <nav id="categoryNav" class="mt-2"></nav>
</header>

<div class="container py-4">
  <div id="adminControls" class="d-flex justify-content-between mb-3">
    <button class="btn btn-success btn-sm" id="addCategoryBtn">Добавить категорию</button>
    <button class="btn btn-success btn-sm" id="addProductBtn">Добавить товар</button>
    <button class="btn btn-secondary btn-sm" id="editStoreBtn">Редактировать магазин</button>
  </div>
  <div id="products" class="row g-4"></div>
</div>

<footer class="bg-dark text-white py-4 mt-5">
  <div class="container text-center" id="footerInfo"></div>
</footer>

<!-- Модальные окна остаются как в твоём файле -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let allProducts = [];
let selectedCategory = null;

const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
const categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
const productModal = new bootstrap.Modal(document.getElementById('productModal'));
const storeModal = new bootstrap.Modal(document.getElementById('storeModal'));

let isAdmin = localStorage.getItem('isAdmin')==='true';
if(!isAdmin){
  document.getElementById('adminControls').style.display='none';
}

// --- Load Store Info ---
async function loadStoreInfo(){
  const res = await fetch('/api/store_info');
  const store = await res.json();
  document.getElementById('storeName').textContent = store.name || 'Smart Service';
  const footer = document.getElementById('footerInfo');
  footer.innerHTML = `
    <p>${store.name || 'Smart Service'} / ИП Ефимова Анастасия Александровна</p>
    <p>ИНН: ${store.inn || '1234567890'}</p>
    <p>Адрес: ${store.address || 'г. Москва, ул. Примерная, д.1'}</p>
    <p>Email: ${store.email || 'info@smartservice.ru'} | Телефон: ${store.phone || '+7 (999) 123-45-67'}</p>
  `;
}

// --- Load Categories ---
async function loadCategories(){
  const res = await fetch('/api/categories');
  const categories = await res.json();
  const nav = document.getElementById('categoryNav');
  nav.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.className = 'btn btn-light btn-sm mx-1';
  allBtn.textContent = 'Все';
  allBtn.onclick = ()=>{selectedCategory=null; renderProducts();};
  nav.appendChild(allBtn);
  categories.forEach(cat=>{
    const btn = document.createElement('button');
    btn.className = 'btn btn-light btn-sm mx-1';
    btn.textContent = cat.name;
    btn.onclick = ()=>{selectedCategory=cat.id; renderProducts();};
    nav.appendChild(btn);
  });

  const select = document.querySelector('#productForm select[name="category_id"]');
  select.innerHTML = '';
  categories.forEach(cat=>{
    const opt = document.createElement('option');
    opt.value = cat.id; opt.textContent = cat.name;
    select.appendChild(opt);
  });
}

// --- Load Products ---
async function loadProducts(){
  const res = await fetch('/api/products');
  allProducts = await res.json();
  renderProducts();
}

function renderProducts(){
  const container = document.getElementById('products');
  container.innerHTML = '';
  let productsToShow = selectedCategory ? allProducts.filter(p=>p.category_id==selectedCategory) : allProducts;
  if(productsToShow.length===0){container.innerHTML='<p>Товаров пока нет</p>'; return;}
  productsToShow.forEach(p=>{
    const img = p.image_url ? p.image_url : 'https://via.placeholder.com/300x200?text=Нет+фото';
    const card = document.createElement('div');
    card.className='col-md-4';
    card.innerHTML=`
      <div class="card h-100 shadow-sm">
        <img src="${img}" class="card-img-top" alt="${p.title}">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">${p.title}</h5>
          <p class="card-text">${p.description || ''}</p>
          <div class="mt-auto">
            <p class="fw-bold">${p.price} ₽</p>
            <div class="d-flex justify-content-between">
              <button class="btn btn-primary btn-sm buy-btn">Купить</button>
              ${isAdmin?'<button class="btn btn-warning btn-sm edit-btn">Редактировать</button><button class="btn btn-danger btn-sm delete-btn">Удалить</button>':''}
            </div>
          </div>
        </div>
      </div>
    `;
    card.querySelector('.buy-btn').onclick=async()=>{
      const userData = JSON.parse(localStorage.getItem('userData'));
      if(!userData){alert('Пожалуйста, зарегистрируйтесь!'); return;}
      await fetch('/api/buy',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:userData,productId:p.id})});
      alert(`Товар "${p.title}" добавлен в корзину!`);
    };
    if(isAdmin){
      card.querySelector('.edit-btn').onclick=()=>openProductModal(p);
      card.querySelector('.delete-btn').onclick=async()=>{
        await fetch(`/api/products/${p.id}`,{method:'DELETE'});
        loadProducts();
      };
    }
    container.appendChild(card);
  });
}

// --- Open Product Modal ---
function openProductModal(product=null){
  const form = document.getElementById('productForm');
  form.reset();
  if(product){
    document.getElementById('productModalTitle').textContent='Редактировать товар';
    form.id.value=product.id; form.title.value=product.title; form.description.value=product.description||''; form.price.value=product.price;
    form.category_id.value=product.category_id;
  }else{
    document.getElementById('productModalTitle').textContent='Добавить товар';
    form.id.value='';
  }
  productModal.show();
}

// --- DOMContentLoaded ---
document.addEventListener('DOMContentLoaded',()=>{
  loadStoreInfo(); loadCategories(); loadProducts();

  if(!localStorage.getItem('userRegistered')){
    registerModal.show();
    document.getElementById('registerForm').addEventListener('submit',async e=>{
      e.preventDefault();
      const form=e.target;
      const data={name:form.name.value,email:form.email.value,phone:form.phone.value};
      await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
      localStorage.setItem('userRegistered','true'); localStorage.setItem('userData',JSON.stringify(data));
      registerModal.hide();
    });
  }

  if(isAdmin){
    document.getElementById('addCategoryBtn').onclick=()=>{document.getElementById('categoryModalTitle').textContent='Добавить категорию'; document.getElementById('categoryForm').reset(); categoryModal.show();};
    document.getElementById('addProductBtn').onclick=()=>openProductModal();
    document.getElementById('editStoreBtn').onclick=async()=>{
      const res = await fetch('/api/store_info'); const store = await res.json();
      const form = document.getElementById('storeForm');
      form.name.value=store.name||''; form.inn.value=store.inn||''; form.address.value=store.address||''; form.email.value=store.email||''; form.phone.value='';
      storeModal.show();
    };

    document.getElementById('categoryForm').addEventListener('submit',async e=>{
      e.preventDefault();
      const form = e.target;
      const data={name:form.name.value};
      await fetch('/api/categories',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
      categoryModal.hide(); loadCategories();
    });

    document.getElementById('productForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const form = e.target;
      const id = form.id.value;
      const fileInput = form.image;
      const formData = new FormData();
      formData.append('title', form.title.value);
      formData.append('description', form.description.value);
      formData.append('price', form.price.value);
      formData.append('category_id', form.category_id.value);
      if(fileInput.files[0]) formData.append('image', fileInput.files[0]);

      if(id){ await fetch(`/api/products/${id}`,{method:'PUT',body:formData}); }
      else{ await fetch('/api/products',{method:'POST',body:formData}); }
      productModal.hide();
      loadProducts();
    });

    document.getElementById('storeForm').addEventListener('submit',async e=>{
      e.preventDefault();
      const form=e.target;
      const data={name:form.name.value,inn:form.inn.value,address:form.address.value,email:form.email.value,phone:form.phone.value};
      await fetch('/api/store_info',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
      storeModal.hide(); loadStoreInfo();
    });
  }

});
</script>
</body>
</html>
