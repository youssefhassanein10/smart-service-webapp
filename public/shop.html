<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MiniApp Shop</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1 { margin-bottom: 20px; }
.category-filter { margin-bottom: 20px; }
.product { border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; display: flex; align-items: center; }
.product img { max-width: 100px; margin-right: 10px; }
.product-info { display: flex; flex-direction: column; }
</style>
</head>
<body>
<h1>Магазин</h1>

<select id="category-filter" class="category-filter" onchange="filterProducts()">
<option value="">Все категории</option>
</select>

<div id="products-container"></div>

<script>
let allProducts = [];
let allCategories = [];

async function loadCategories(){
    const res = await fetch('/api/categories');
    allCategories = await res.json();
    const filter = document.getElementById('category-filter');
    filter.innerHTML = '<option value="">Все категории</option>';
    allCategories.forEach(c=>{
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        filter.appendChild(opt);
    });
}

async function loadProducts(){
    const res = await fetch('/api/products');
    allProducts = await res.json();
    displayProducts(allProducts);
}

function displayProducts(products){
    const container = document.getElementById('products-container');
    container.innerHTML = '';
    products.forEach(p=>{
        const div = document.createElement('div');
        div.className = 'product';
        div.innerHTML = `
            ${p.image_url ? `<img src="${p.image_url}" alt="${p.title}">` : ''}
            <div class="product-info">
                <b>${p.title}</b>
                <span>${p.description || ''}</span>
                <span>Цена: ${p.price} руб.</span>
                <span>Категория: ${getCategoryName(p.category_id)}</span>
            </div>
        `;
        container.appendChild(div);
    });
}

function getCategoryName(id){
    const cat = allCategories.find(c=>c.id==id);
    return cat ? cat.name : '';
}

function filterProducts(){
    const catId = document.getElementById('category-filter').value;
    if(!catId){
        displayProducts(allProducts);
    } else {
        displayProducts(allProducts.filter(p=>p.category_id==catId));
    }
}

// --- Initial load ---
loadCategories().then(loadProducts);
</script>
</body>
</html>
