<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>MiniApp Магазин</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
<h1 id="storeName" class="text-center mb-4"></h1>
<div class="row mb-3">
<select id="categoryFilter" class="form-select w-auto mx-auto">
<option value="">Все категории</option>
</select>
</div>
<div id="productList" class="row g-3"></div>

<!-- Footer -->
<footer class="text-center mt-4" id="storeFooter"></footer>

<!-- Регистрация -->
<div class="modal" tabindex="-1" id="registerModal">
<div class="modal-dialog"><div class="modal-content p-3">
<h5>Регистрация</h5>
<input type="text" id="regName" placeholder="Имя" class="form-control mb-2">
<input type="email" id="regEmail" placeholder="Email" class="form-control mb-2">
<input type="tel" id="regPhone" placeholder="Телефон" class="form-control mb-2">
<button id="regBtn" class="btn btn-primary">Зарегистрироваться</button>
</div></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentUser = JSON.parse(localStorage.getItem('user')) || null;

async function loadStoreInfo(){
  const res = await fetch('/api/store_info'); const data=await res.json();
  document.getElementById('storeName').textContent=data.name||'Магазин';
  document.getElementById('storeFooter').textContent=`${data.name||''} | ИНН: ${data.inn||''} | ${data.address||''}`;
}

async function loadCategories(){
  const res = await fetch('/api/categories'); const data=await res.json();
  const filter = document.getElementById('categoryFilter');
  filter.innerHTML='<option value="">Все категории</option>';
  data.forEach(c=>filter.innerHTML+=`<option value="${c.id}">${c.name}</option>`);
}

async function loadProducts(category=''){
  let url='/api/products';
  const res = await fetch(url); const data=await res.json();
  if(category) data=data.filter(p=>Number(p.category_id)===Number(category));
  const list=document.getElementById('productList'); list.innerHTML='';
  data.forEach(p=>{
    const div=document.createElement('div'); div.className='col-4 card p-2';
    div.innerHTML=`<img src="${p.image_url}" class="img-fluid mb-2"><h5>${p.title}</h5><p>${p.description}</p><b>${p.price} ₽</b>`;
    list.appendChild(div);
  });
}

document.getElementById('categoryFilter').addEventListener('change', e=>loadProducts(e.target.value));

if(!currentUser){
  const modal = new bootstrap.Modal(document.getElementById('registerModal'));
  modal.show();
  document.getElementById('regBtn').addEventListener('click', async ()=>{
    const name=document.getElementById('regName').value;
    const email=document.getElementById('regEmail').value;
    const phone=document.getElementById('regPhone').value;
    if(!name||!email||!phone) return alert('Заполните все поля');
    await fetch('/api/register',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name,email,phone})});
    localStorage.setItem('user',JSON.stringify({name,email,phone}));
    modal.hide();
    currentUser={name,email,phone};
  });
}

loadStoreInfo(); loadCategories(); loadProducts();
</script>
</body>
</html>
