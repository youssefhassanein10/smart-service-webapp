<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Smart Service - MiniApp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<header class="bg-primary text-white py-3 mb-4 text-center">
  <h1 id="storeName">Smart Service</h1>
  <nav id="categoryNav" class="mt-2"></nav>
</header>

<div class="container py-4">
  <!-- Админ-кнопки скрыты для обычного пользователя -->
  <div id="adminControls" class="d-flex justify-content-between mb-3" style="display:none;">
    <button class="btn btn-success btn-sm" id="addCategoryBtn">Добавить категорию</button>
    <button class="btn btn-success btn-sm" id="addProductBtn">Добавить товар</button>
    <button class="btn btn-secondary btn-sm" id="editStoreBtn">Редактировать магазин</button>
  </div>
  <div id="products" class="row g-4"></div>
</div>

<footer class="bg-dark text-white py-4 mt-5">
  <div class="container text-center" id="footerInfo"></div>
</footer>

<!-- Модальные окна (регистрация, категории, товары, магазин) оставлены как в предыдущей версии -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let allProducts = [];
let selectedCategory = null;

const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
const categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
const productModal = new bootstrap.Modal(document.getElementById('productModal'));
const storeModal = new bootstrap.Modal(document.getElementById('storeModal'));

const ADMIN_TOKEN = 'SUPER_SECRET_TOKEN'; // Твой секретный токен для админа

async function checkAdmin(){
  const res = await fetch('/api/is_admin', {
    headers:{'x-admin-token': ADMIN_TOKEN}
  });
  const data = await res.json();
  if(data.admin) document.getElementById('adminControls').style.display='flex';
  return data.admin;
}

async function loadStoreInfo(){
  const res = await fetch('/api/store_info');
  const store = await res.json();
  document.getElementById('storeName').textContent = store.name || 'Smart Service';
  const footer = document.getElementById('footerInfo');
  footer.innerHTML = `
    <p>${store.name || 'Smart Service'} / ИП Ефимова Анастасия Александровна</p>
    <p>ИНН: ${store.inn || '1234567890'}</p>
    <p>Адрес: ${store.address || 'г. Москва, ул. Примерная, д.1'}</p>
    <p>Email: ${store.email || 'info@smartservice.ru'} | Телефон: ${store.phone || '+7 (999) 123-45-67'}</p>
  `;
}

async function loadCategories(){
  const res = await fetch('/api/categories');
  const categories = await res.json();
  const nav = document.getElementById('categoryNav');
  nav.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.className = 'btn btn-light btn-sm mx-1';
  allBtn.textContent = 'Все';
  allBtn.onclick = ()=>{selectedCategory=null; renderProducts();};
  nav.appendChild(allBtn);
  categories.forEach(cat=>{
    const btn = document.createElement('button');
    btn.className = 'btn btn-light btn-sm mx-1';
    btn.textContent = cat.name;
    btn.onclick = ()=>{selectedCategory=cat.id; renderProducts();};
    nav.appendChild(btn);
  });

  const select = document.querySelector('#productForm select[name="category_id"]');
  if(select){
    select.innerHTML = '';
    categories.forEach(cat=>{
      const opt = document.createElement('option');
      opt.value = cat.id; opt.textContent = cat.name;
      select.appendChild(opt);
    });
  }
}

async function loadProducts(){
  const res = await fetch('/api/products');
  allProducts = await res.json();
  renderProducts();
}

function renderProducts(){
  const container = document.getElementById('products');
  container.innerHTML = '';
  let productsToShow = selectedCategory ? allProducts.filter(p=>p.category_id==selectedCategory) : allProducts;
  if(productsToShow.length===0){container.innerHTML='<p>Товаров пока нет</p>'; return;}
  productsToShow.forEach(p=>{
    const img = p.image_url ? p.image_url : 'https://via.placeholder.com/300x200?text=Нет+фото';
    const card = document.createElement('div');
    card.className='col-md-4';
    card.innerHTML=`
      <div class="card h-100 shadow-sm">
        <img src="${img}" class="card-img-top" alt="${p.title}">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">${p.title}</h5>
          <p class="card-text">${p.description || ''}</p>
          <div class="mt-auto">
            <p class="fw-bold">${p.price} ₽</p>
            <div class="d-flex justify-content-between">
              <button class="btn btn-primary btn-sm buy-btn">Купить</button>
            </div>
          </div>
        </div>
      </div>
    `;
    card.querySelector('.buy-btn').onclick=async()=>{
      const userData = JSON.parse(localStorage.getItem('userData'));
      if(!userData){alert('Пожалуйста, зарегистрируйтесь!'); return;}
      await fetch('/api/buy',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user:userData,productId:p.id})});
      alert(`Товар "${p.title}" добавлен в корзину!`);
    };
    container.appendChild(card);
  });
}

document.addEventListener('DOMContentLoaded',async()=>{
  await checkAdmin(); // покажет кнопки только администратору
  loadStoreInfo(); 
  loadCategories(); 
  loadProducts();

  // Регистрация пользователя
  if(!localStorage.getItem('userRegistered')){
    registerModal.show();
    document.getElementById('registerForm').addEventListener('submit',async e=>{
      e.preventDefault();
      const form=e.target;
      const data={name:form.name.value,email:form.email.value,phone:form.phone.value};
      await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
      localStorage.setItem('userRegistered','true'); 
      localStorage.setItem('userData',JSON.stringify(data));
      registerModal.hide();
    });
  }
});
</script>
</body>
</html>
