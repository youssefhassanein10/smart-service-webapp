<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Админка магазина</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
h2 { margin-top: 30px; }
input, select, button { margin: 5px 0; padding: 5px; }
table { border-collapse: collapse; margin-top: 10px; width: 100%; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 8px; text-align: left; }
img { max-width: 100px; }
</style>
</head>
<body>

<h1>Админка магазина</h1>

<h2>Категории</h2>
<input type="text" id="categoryName" placeholder="Название категории">
<button id="addCategoryBtn">Добавить категорию</button>
<table id="categoriesTable">
  <thead><tr><th>ID</th><th>Название</th></tr></thead>
  <tbody></tbody>
</table>

<h2>Товары</h2>
<input type="text" id="productName" placeholder="Название товара">
<input type="number" id="productPrice" placeholder="Цена">
<select id="productCategory"></select>
<input type="file" id="productImage">
<button id="addProductBtn">Добавить товар</button>
<table id="productsTable">
  <thead><tr><th>ID</th><th>Название</th><th>Цена</th><th>Категория</th><th>Фото</th></tr></thead>
  <tbody></tbody>
</table>

<script>
// Подгружаем категории
async function loadCategories() {
  const res = await fetch('/categories');
  const categories = await res.json();
  const tbody = document.querySelector('#categoriesTable tbody');
  tbody.innerHTML = '';
  const select = document.getElementById('productCategory');
  select.innerHTML = '';
  categories.forEach(cat => {
    tbody.innerHTML += `<tr><td>${cat.id}</td><td>${cat.name}</td></tr>`;
    select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
  });
}

// Подгружаем товары
async function loadProducts() {
  const res = await fetch('/products');
  const products = await res.json();
  const tbody = document.querySelector('#productsTable tbody');
  tbody.innerHTML = '';
  products.forEach(prod => {
    tbody.innerHTML += `
      <tr>
        <td>${prod.id}</td>
        <td>${prod.name}</td>
        <td>${prod.price}</td>
        <td>${prod.category_id}</td>
        <td>${prod.image ? `<img src="${prod.image}">` : ''}</td>
      </tr>`;
  });
}

// Добавление категории
document.getElementById('addCategoryBtn').addEventListener('click', async () => {
  const name = document.getElementById('categoryName').value.trim();
  if (!name) return alert('Введите название категории');
  try {
    const res = await fetch('/add-category', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });
    if (res.ok) {
      document.getElementById('categoryName').value = '';
      loadCategories();
    } else {
      const err = await res.text();
      alert('Ошибка при добавлении категории: ' + err);
    }
  } catch (e) {
    alert('Ошибка сети: ' + e.message);
  }
});

// Добавление товара
document.getElementById('addProductBtn').addEventListener('click', async () => {
  const name = document.getElementById('productName').value.trim();
  const price = document.getElementById('productPrice').value.trim();
  const category_id = document.getElementById('productCategory').value;
  const imageFile = document.getElementById('productImage').files[0];

  if (!name || !price || !category_id) return alert('Заполните все поля');

  const formData = new FormData();
  formData.append('name', name);
  formData.append('price', price);
  formData.append('category_id', category_id);
  if (imageFile) formData.append('image', imageFile);

  try {
    const res = await fetch('/add-product', {
      method: 'POST',
      body: formData
    });
    if (res.ok) {
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productImage').value = '';
      loadProducts();
    } else {
      const err = await res.text();
      alert('Ошибка при добавлении товара: ' + err);
    }
  } catch (e) {
    alert('Ошибка сети: ' + e.message);
  }
});

// Загрузка данных при старте
loadCategories();
loadProducts();
</script>

</body>
</html>
